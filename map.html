<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>nearby IG images</title>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.31.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.31.0/mapbox-gl.css' rel='stylesheet' />

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> 

    <style>
    body {background: #333; margin:0;padding:0;}
    #map { position:absolute; top:0; bottom:0; width:100%; }

    </style>
</head>
<body>
<style>
  #marker {
      background-image: url('https://www.mapbox.com/mapbox-gl-js/assets/washington-monument.jpg');
      background-size: cover;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
  }

  .mapboxgl-popup {
      max-width: 200px;
  }
</style>
<div id='map'></div>
<script>

function getQueryVariable(variable) {
    var query = window.location.hash.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
        }
    }
    console.log('Query variable %s not found', variable);
}

var igToken = getQueryVariable('access_token');

var API_ENDPOINT = 'https://api.instagram.com/v1/media/search?lat=45.52245801087795&lng=-122.67773866653444&callback=?&access_token=' + igToken;

mapboxgl.accessToken = 'pk.eyJ1IjoiZ3JhZmEiLCJhIjoiZjk3Mjk2YWYzZTNlYjM3ODdlNzJlOWJlM2VjZGI0ZDEifQ.OTT9oT7CqAc9vZsnJLT51Q';

var cooords = [];

var FeatureCollection = {
  type: "FeatureCollection",
  features: [{"type": "Feature","geometry": {"type": "Point", "coordinates": []},"properties":{}}]
};

$.getJSON(API_ENDPOINT, function(result, status) {
    
    if (status !== 'success') return alert('Request to IG failed');
    for (var i = result.data.length - 1; i >= 0; i--) {
      var lng = parseFloat(result.data[i].location.longitude);
          lat = parseFloat(result.data[i].location.latitude);

      cooords.push(lng,lat);

      FeatureCollection.features[i].geometry.coordinates
          .push(cooords);
      var IGThumb = result.data[i].images.thumbnail.url,
          IGLink = result.data[i].link;
          IGPlace = result.data[i].location.name;
          console.log(result.data[i]);
    };
    
    // add markers to map
    FeatureCollection.features.forEach(function(marker) {
      // create the popup
      var popup = new mapboxgl.Popup({offset: 25})
          .setHTML('<a href="' + IGLink + '">' + IGPlace+ '</a>');
          // <a href="http://html.com/attributes/a-href/">Learn about the a href attribute</a>


      // create DOM element for the marker
      var el = document.createElement('div');
      el.id = 'marker';
      el.style.backgroundImage = 'url('+ IGThumb + ')';

      // create the marker
      new mapboxgl.Marker(el, {offset:[-25, -25]})
          .setLngLat(cooords)
          .setPopup(popup) // sets a popup on this marker
          .addTo(map);   

    });
});

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/grafa/cizra0c0x006c2sp6pqer3py2',
    center: [-122.67773866653444,45.52245801087795],
    zoom: 12
});

</script>

</script>
</body>
</html>

